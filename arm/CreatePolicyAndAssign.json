{
	"$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"tagName": {
			"type": "String",
			"metadata": {
				"displayName": "TagName",
				"description": "Name of the tag",
				"default": "type"
			}
		},
		"tagValue": {
			"type": "String",
			"metadata": {
				"displayName": "TagValue",
				"description": "Value of the tag, such as 'production'",
				"default": "sensitive"
			}
		}
	},
	"functions": [

	],
	"variables": {
		"policyName": "[concat('crodriguezde', uniqueString('PolicyTest12345'))]"
	},
	"resources": [
		{
			"type": "Microsoft.Authorization/policyDefinitions",
			"name": "[variables('policyName')]",
			"apiVersion": "2019-09-01",
			"properties": {
				"displayName": "[variables('policyName')]",
				"policyType": "Custom",
				"mode": "Indexed",
				"description": "ARM deployed policy",
				"metadata": {
					"version": "1.0.1",
					"category": "crodriguezdeAutoPolicy"
				},
				"parameters": {

				},
				"policyRule": {
					"if": {
						"allOf": [
							{
								"field": "type",
								"equals": "Microsoft.Resources/subscriptions/resourceGroups"
							},
							{
								"field": "[concat('tags[', parameters('tagName'), ']')]",
								"exists": "false"
							}
						]
					},
					"then": {
						"effect": "modify",
						"details": {
							"roleDefinitionIds": [
								"/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
							],
							"operations": [
								{
									"operation": "add",
									"field": "[concat('tags[', parameters('tagName'), ']')]",
									"value": "[parameters('tagValue')]"
								}
							]
						}
					}
				}
			}
		},
		{
			"type": "Microsoft.Authorization/policyAssignments",
			"name": "Policy080320201450PM-Assignment",
			"apiVersion": "2019-09-01",
			"dependsOn": [
				"[resourceId('Microsoft.Authorization/policyDefinitions/', variables('policyName'))]"
			],
			"properties": {
				"policyDefinitionId": "[concat(subscription().id, '/providers/Microsoft.Authorization/policyDefinitions/', variables('policyName'))]"
			}
		}
	],
	"outputs": {
		"policyName": {
			"type": "string",
			"value": "[variables('policyName')]"
		}
	}
}
